@model SmartCourseSelectorWeb.Models.Student

@{
    ViewData["Title"] = "Student Courses";
}

<style>
    .content-container {
        max-width: 75%;
    }

    .success-message {
        color: green;
        font-weight: bold;
        margin-top: 20px;
    }

    .hidden {
        display: none;
    }
</style>

<div class="container">
    <h2>Student Courses</h2>
    <h4>Student Information</h4>
    <p><strong>Name:</strong> @Model.FirstName @Model.LastName</p>
    <p><strong>Student ID:</strong> @Model.StudentID</p>
    <p><strong>Department:</strong> @Model.Department</p>

    <hr />

    @if (Model.StudentCourseSelections == null || !Model.StudentCourseSelections.Any())
    {
        <div class="alert alert-warning">
            No courses have been selected by this student.
        </div>
    }
    else
    {
        <h4>Selected Courses</h4>

        <!-- Form ile checkbox seçimini gönder -->
        <form asp-action="ApproveStudentsCourses" asp-controller="Advisors" method="post" id="approveForm">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Course Name</th>
                        <th>Credit</th>
                        <th>Mandatory</th>
                        <th>Selection Date</th>
                        <th>Approve?</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var courseSelection in Model.StudentCourseSelections)
                    {
                        <tr>
                            <td>@courseSelection.Course.CourseName</td>
                            <td>@courseSelection.Course.Credit</td>
                            <td>@(courseSelection.Course.IsMandatory ? "Yes" : "No")</td>
                            <td>@courseSelection.SelectionDate.ToString("d")</td>
                            <td>
                                @if (courseSelection.IsApproved)
                                {
                                    <input type="checkbox" name="SelectedCourseIds" value="@courseSelection.CourseID" checked />
                                }
                                else
                                {
                                    <input type="checkbox" name="SelectedCourseIds" value="@courseSelection.CourseID" />
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            <div class="form-group">
                <button type="submit" id="submitBtn" class="btn btn-primary">Approve</button>
            </div>
        </form>

        <!-- Success Message -->
        <div id="successMessage" class="success-message hidden">
            Courses approved successfully!
        </div>
    }
</div>

<script>
    // Success message handling
    function showSuccessMessage() {
        var successMessage = document.getElementById("successMessage");
        successMessage.classList.remove("hidden");

        // Hide the success message after 3 seconds
        setTimeout(function() {
            successMessage.classList.add("hidden");
        }, 3000);
    }

    // Modify course IDs before submission and handle IsApproved for unchecked courses
    document.getElementById("approveForm").onsubmit = function (event) {
        // Collect all the checked checkboxes
        var selectedCheckboxes = document.querySelectorAll('input[name="SelectedCourseIds"]:checked');

        // Collect all unchecked checkboxes and handle their approval status
        var uncheckedCheckboxes = document.querySelectorAll('input[name="SelectedCourseIds"]:not(:checked)');
        uncheckedCheckboxes.forEach(function (checkbox) {
            // Ensure that IsApproved for unchecked courses is set to false
            var courseRow = checkbox.closest('tr');
            var courseId = checkbox.value;

            // Adding a hidden input field to mark IsApproved as false for unchecked courses
            var isApprovedInput = document.createElement('input');
            isApprovedInput.type = 'hidden';
            isApprovedInput.name = 'UncheckedCourseIds'; // New list of unchecked course IDs
            isApprovedInput.value = courseId + ":" + false;  // We are sending the course ID and approval status
            courseRow.appendChild(isApprovedInput);
        });

        // You can now proceed with form submission, it will include the updated course IDs and approval status
    }

    // If the page reloads with success, show the success message
    @if (TempData["Success"] != null)
    {
        <text>
                    showSuccessMessage();
        </text>
    }
</script>
